name: Build and Deploy Sphinx Documentation
on:
  push:
    branches:
      - main
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'

    - name: Cache Python dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install sphinx sphinx_rtd_theme nbsphinx
        pip install .
        pip freeze
        sudo apt-get install pandoc

    # ... autres étapes inchangées ...

    - name: Clean GitHub Actions Cache
      run: |
        gh extension install actions/gh-actions-cache
        
        REPO=${{ github.repository }}
        BRANCH="refs/heads/main"

        echo "Fetching list of cache key"
        cacheKeysForPR=$(gh actions-cache list -R $REPO -B $BRANCH | cut -f 1 )

        ## Setting this to not fail the workflow while deleting cache keys. 
        set +e
        echo "Deleting caches..."
        for cacheKey in $cacheKeysForPR
        do
            gh actions-cache delete $cacheKey -R $REPO -B $BRANCH --confirm
        done
        echo "Done"

    - name: Deploy to GitHub Pages
      uses: JamesIves/github-pages-deploy-action@v4.6.6
      with:
        folder: docs/_build/html
        clean: true
        clean-exclude: |
          .nojekyll

    - name: Add .nojekyll file
      run: |
        cd docs/_build/html
        touch .nojekyll